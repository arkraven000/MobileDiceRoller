name: CI

on:
  push:
    branches:
      - main
      - 'claude/**'
  pull_request:
    branches:
      - main

env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer

jobs:
  # SwiftLint - Code Quality Check
  swiftlint:
    name: SwiftLint
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --strict --reporter github-actions-logging

  # Build - Verify project builds successfully
  build:
    name: Build
    runs-on: macos-14
    strategy:
      matrix:
        destination:
          - 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2'
          - 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=17.2'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show Swift version
        run: swift --version

      - name: Build for testing
        run: |
          xcodebuild build-for-testing \
            -scheme MobileDiceRoller \
            -destination "${{ matrix.destination }}" \
            -derivedDataPath .build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

  # Unit Tests - Run all unit tests with coverage
  unit-tests:
    name: Unit Tests
    runs-on: macos-14
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Run unit tests
        run: |
          xcodebuild test \
            -scheme MobileDiceRoller \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
            -derivedDataPath .build \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Generate code coverage report
        run: |
          # Find the test binary and profdata
          TEST_BINARY=$(find .build/Build/Products -name "MobileDiceRollerPackageTests.xctest" -type d | head -1)
          PROFDATA=$(find .build/Build/ProfileData -name "Coverage.profdata" | head -1)

          if [ -z "$TEST_BINARY" ] || [ -z "$PROFDATA" ]; then
            echo "‚ö†Ô∏è Could not find test binary or coverage data"
            exit 0
          fi

          BINARY_PATH="$TEST_BINARY/Contents/MacOS/MobileDiceRollerPackageTests"

          xcrun llvm-cov export \
            -format="lcov" \
            "$BINARY_PATH" \
            -instr-profile "$PROFDATA" \
            > coverage.lcov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.lcov
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Check code coverage threshold
        run: |
          # Find the test binary and profdata
          TEST_BINARY=$(find .build/Build/Products -name "MobileDiceRollerPackageTests.xctest" -type d | head -1)
          PROFDATA=$(find .build/Build/ProfileData -name "Coverage.profdata" | head -1)

          if [ -z "$TEST_BINARY" ] || [ -z "$PROFDATA" ]; then
            echo "‚ö†Ô∏è Could not find test binary or coverage data, skipping threshold check"
            exit 0
          fi

          BINARY_PATH="$TEST_BINARY/Contents/MacOS/MobileDiceRollerPackageTests"

          COVERAGE=$(xcrun llvm-cov report \
            "$BINARY_PATH" \
            -instr-profile "$PROFDATA" \
            | grep "TOTAL" | awk '{print $NF}' | sed 's/%//')

          echo "Code Coverage: $COVERAGE%"

          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "‚ùå Code coverage ($COVERAGE%) is below the required 80% threshold"
            exit 1
          else
            echo "‚úÖ Code coverage ($COVERAGE%) meets the 80% threshold"
          fi

  # UI Tests - Run UI tests for critical flows
  ui-tests:
    name: UI Tests
    runs-on: macos-14
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Run UI tests
        run: |
          # Check if UI tests exist
          if [ -d "Tests/MobileDiceRollerUITests" ]; then
            xcodebuild test \
              -scheme MobileDiceRoller \
              -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
              -derivedDataPath .build \
              -only-testing:MobileDiceRollerUITests \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO
          else
            echo "‚ö†Ô∏è UI tests not yet implemented (Phase 10)"
            echo "‚úÖ Skipping UI tests"
          fi

  # Performance Tests - Verify performance benchmarks
  performance-tests:
    name: Performance Tests
    runs-on: macos-14
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Run performance tests
        run: |
          # Check if performance tests exist
          if [ -f "Tests/MobileDiceRollerTests/PerformanceTests/PerformanceTests.swift" ]; then
            xcodebuild test \
              -scheme MobileDiceRoller \
              -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
              -derivedDataPath .build \
              -only-testing:MobileDiceRollerTests/PerformanceTests \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO
          else
            echo "‚ö†Ô∏è Performance tests not yet implemented (Phase 10)"
            echo "‚úÖ Skipping performance tests"
          fi

  # Security Scan - Check for security issues
  security-scan:
    name: Security Scan
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security audit
        run: |
          # Check for hardcoded secrets
          echo "üîç Scanning for hardcoded secrets..."

          # Patterns to search for
          PATTERNS=(
            "password\s*=\s*['\"]"
            "api[_-]?key\s*=\s*['\"]"
            "secret\s*=\s*['\"]"
            "token\s*=\s*['\"]"
            "AKIA[0-9A-Z]{16}"
          )

          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" Sources/; then
              echo "‚ùå Found potential hardcoded secret: $pattern"
              exit 1
            fi
          done

          echo "‚úÖ No hardcoded secrets found"

      - name: Check for force unwraps
        run: |
          echo "üîç Checking for force unwraps..."
          # Look for force unwraps (!) but exclude:
          # - Comments: //.*!
          # - Not equal: !=
          # - Property wrappers: @State!, @Binding!, etc.
          # - Multiline comments
          if grep -rE '([^=!@/])\s*!\s*[^=]' Sources/ | grep -v '//' | grep -v '\*' || true; then
            echo "‚ö†Ô∏è Found potential force unwraps - review carefully (some may be false positives)"
          else
            echo "‚úÖ No obvious force unwraps found"
          fi

  # Documentation - Verify documentation builds
  documentation:
    name: Build Documentation
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Build documentation
        run: |
          xcodebuild docbuild \
            -scheme MobileDiceRoller \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
            -derivedDataPath .build

      - name: Archive documentation
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Archive the generated documentation
          find .build -name "*.doccarchive" -exec cp -R {} ./docs/ \;

      - name: Upload documentation artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v3
        with:
          name: documentation
          path: docs/*.doccarchive

  # All checks passed
  all-checks:
    name: All Checks Passed
    runs-on: macos-14
    needs:
      - swiftlint
      - build
      - unit-tests
      - ui-tests
      - performance-tests
      - security-scan
      - documentation
    steps:
      - name: Success
        run: |
          echo "‚úÖ All CI checks passed successfully!"
          echo "üìä Code quality: PASSED"
          echo "üèóÔ∏è  Build: PASSED"
          echo "üß™ Tests: PASSED"
          echo "üîí Security: PASSED"
          echo "üìñ Documentation: PASSED"
