name: CI

on:
  push:
    branches:
      - main
      - 'claude/**'
  pull_request:
    branches:
      - main

env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer

jobs:
  # SwiftLint - Code Quality Check
  swiftlint:
    name: SwiftLint
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --strict --reporter github-actions-logging

  # Build - Verify project builds successfully
  build:
    name: Build
    runs-on: macos-14
    strategy:
      matrix:
        destination:
          - 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2'
          - 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=17.2'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show Swift version
        run: swift --version

      - name: Build for testing
        run: |
          xcodebuild build-for-testing \
            -scheme MobileDiceRoller \
            -destination "${{ matrix.destination }}" \
            -derivedDataPath .build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

  # Unit Tests - Run all unit tests with coverage
  unit-tests:
    name: Unit Tests
    runs-on: macos-14
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Run unit tests
        run: |
          xcodebuild test \
            -scheme MobileDiceRoller \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
            -derivedDataPath .build \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Generate code coverage report
        run: |
          xcrun llvm-cov export \
            -format="lcov" \
            .build/Build/ProfileData/*/Coverage.profdata \
            -instr-profile .build/Build/ProfileData/*/Coverage.profdata \
            > coverage.lcov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.lcov
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Check code coverage threshold
        run: |
          COVERAGE=$(xcrun llvm-cov report \
            .build/Build/ProfileData/*/Coverage.profdata \
            -instr-profile .build/Build/ProfileData/*/Coverage.profdata \
            | grep "TOTAL" | awk '{print $NF}' | sed 's/%//')

          echo "Code Coverage: $COVERAGE%"

          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ Code coverage ($COVERAGE%) is below the required 80% threshold"
            exit 1
          else
            echo "âœ… Code coverage ($COVERAGE%) meets the 80% threshold"
          fi

  # UI Tests - Run UI tests for critical flows
  ui-tests:
    name: UI Tests
    runs-on: macos-14
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Run UI tests
        run: |
          xcodebuild test \
            -scheme MobileDiceRoller \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
            -derivedDataPath .build \
            -only-testing:MobileDiceRollerUITests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

  # Performance Tests - Verify performance benchmarks
  performance-tests:
    name: Performance Tests
    runs-on: macos-14
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Run performance tests
        run: |
          xcodebuild test \
            -scheme MobileDiceRoller \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
            -derivedDataPath .build \
            -only-testing:MobileDiceRollerTests/PerformanceTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

  # Security Scan - Check for security issues
  security-scan:
    name: Security Scan
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security audit
        run: |
          # Check for hardcoded secrets
          echo "ðŸ” Scanning for hardcoded secrets..."

          # Patterns to search for
          PATTERNS=(
            "password\s*=\s*['\"]"
            "api[_-]?key\s*=\s*['\"]"
            "secret\s*=\s*['\"]"
            "token\s*=\s*['\"]"
            "AKIA[0-9A-Z]{16}"
          )

          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" Sources/; then
              echo "âŒ Found potential hardcoded secret: $pattern"
              exit 1
            fi
          done

          echo "âœ… No hardcoded secrets found"

      - name: Check for force unwraps
        run: |
          echo "ðŸ” Checking for force unwraps..."
          if grep -rE '\w+!' Sources/ | grep -v '//.*!'; then
            echo "âš ï¸ Found force unwraps - review carefully"
          else
            echo "âœ… No force unwraps found"
          fi

  # Documentation - Verify documentation builds
  documentation:
    name: Build Documentation
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Build documentation
        run: |
          xcodebuild docbuild \
            -scheme MobileDiceRoller \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.2' \
            -derivedDataPath .build

      - name: Archive documentation
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Archive the generated documentation
          find .build -name "*.doccarchive" -exec cp -R {} ./docs/ \;

      - name: Upload documentation artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v3
        with:
          name: documentation
          path: docs/*.doccarchive

  # All checks passed
  all-checks:
    name: All Checks Passed
    runs-on: macos-14
    needs:
      - swiftlint
      - build
      - unit-tests
      - ui-tests
      - performance-tests
      - security-scan
      - documentation
    steps:
      - name: Success
        run: |
          echo "âœ… All CI checks passed successfully!"
          echo "ðŸ“Š Code quality: PASSED"
          echo "ðŸ—ï¸  Build: PASSED"
          echo "ðŸ§ª Tests: PASSED"
          echo "ðŸ”’ Security: PASSED"
          echo "ðŸ“– Documentation: PASSED"
